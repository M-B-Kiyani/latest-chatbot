<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG System Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #0f172a;
        color: #e2e8f0;
      }
      h1 {
        color: #60a5fa;
        border-bottom: 2px solid #1e293b;
        padding-bottom: 10px;
      }
      .status {
        background: #1e293b;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .test-query {
        background: #1e293b;
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
      }
      .query-text {
        font-size: 16px;
        font-weight: 600;
        color: #60a5fa;
        margin-bottom: 10px;
      }
      .result {
        background: #0f172a;
        padding: 12px;
        border-radius: 6px;
        margin-top: 10px;
        font-size: 14px;
        line-height: 1.6;
      }
      .success {
        color: #10b981;
      }
      .warning {
        color: #f59e0b;
      }
      .error {
        color: #ef4444;
      }
      .info {
        color: #60a5fa;
      }
      button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        margin: 10px 5px;
      }
      button:hover {
        background: #2563eb;
      }
      button:disabled {
        background: #475569;
        cursor: not-allowed;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #475569;
        border-top-color: #60a5fa;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      pre {
        background: #0a0f1a;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>üß™ RAG System Test</h1>

    <div class="status" id="status">
      <div class="loading"></div>
      Loading knowledge base...
    </div>

    <div>
      <button onclick="runAllTests()" id="runBtn">Run All Tests</button>
      <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="results"></div>

    <script type="module">
      import { knowledgeService } from "./services/knowledgeService.js";

      // Wait for knowledge base to load
      await new Promise((resolve) => setTimeout(resolve, 2000));

      const stats = knowledgeService.getStats();
      const statusDiv = document.getElementById("status");

      if (stats.loaded) {
        statusDiv.innerHTML = `
                <div class="success">‚úÖ Knowledge Base Loaded</div>
                <div class="info">üì¶ Total Chunks: ${stats.chunks}</div>
                <div class="info">üìÖ Last Updated: ${new Date(
                  stats.lastUpdated
                ).toLocaleString()}</div>
            `;
        document.getElementById("runBtn").disabled = false;
      } else {
        statusDiv.innerHTML = `
                <div class="error">‚ùå Knowledge Base Not Loaded</div>
                <div class="warning">Run: npm run build:knowledge:all</div>
            `;
        document.getElementById("runBtn").disabled = true;
      }

      const testQueries = [
        {
          query: "What services does Metalogics offer?",
          topic: "Services Overview",
        },
        { query: "How much does a website cost?", topic: "Pricing" },
        {
          query: "Tell me about web development services",
          topic: "Web Development",
        },
        { query: "Do you offer SEO services?", topic: "SEO" },
        { query: "What is the company history?", topic: "Company Info" },
        { query: "How do I contact Metalogics?", topic: "Contact" },
        {
          query: "What is your process for starting a project?",
          topic: "Process",
        },
        { query: "Do you work with blockchain or Web3?", topic: "Web3" },
      ];

      window.runAllTests = async function () {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "<h2>üîç Test Results</h2>";
        document.getElementById("runBtn").disabled = true;

        for (let i = 0; i < testQueries.length; i++) {
          const { query, topic } = testQueries[i];

          const testDiv = document.createElement("div");
          testDiv.className = "test-query";
          testDiv.innerHTML = `
                    <div class="query-text">Test ${i + 1}/${
            testQueries.length
          }: ${topic}</div>
                    <div class="info">Query: "${query}"</div>
                    <div class="result"><div class="loading"></div> Processing...</div>
                `;
          resultsDiv.appendChild(testDiv);

          const startTime = Date.now();
          const context = await knowledgeService.retrieveRelevantContext(
            query,
            3
          );
          const duration = Date.now() - startTime;

          const resultDiv = testDiv.querySelector(".result");

          if (context) {
            const chunks = context.split("\n\n---\n\n");
            const officialCount = (context.match(/üìå Official/g) || []).length;
            const websiteCount = (context.match(/üåê Website/g) || []).length;

            const firstChunk = chunks[0];
            const lines = firstChunk.split("\n");
            const sourceLabel = lines[0];
            const contentPreview = lines
              .slice(1, 4)
              .join("\n")
              .substring(0, 200);

            const relevanceMatch = firstChunk.match(/Relevance: (\d+)%/);
            const relevance = relevanceMatch ? parseInt(relevanceMatch[1]) : 0;

            let qualityBadge = "";
            if (relevance >= 70) qualityBadge = "üü¢ Excellent";
            else if (relevance >= 50) qualityBadge = "üü° Good";
            else qualityBadge = "üü† Fair";

            resultDiv.innerHTML = `
                        <div class="success">‚úÖ Context Retrieved (${duration}ms)</div>
                        <div class="info">üì¶ Chunks: ${chunks.length} | Sources: ${officialCount} Official, ${websiteCount} Website</div>
                        <div class="info">üìä Relevance: ${relevance}% ${qualityBadge}</div>
                        <div class="info">üìè Length: ${context.length} characters</div>
                        <details>
                            <summary style="cursor: pointer; margin-top: 10px;">View Context Preview</summary>
                            <pre>${sourceLabel}\n${contentPreview}...</pre>
                        </details>
                    `;
          } else {
            resultDiv.innerHTML = `<div class="error">‚ùå No relevant context found (${duration}ms)</div>`;
          }

          // Small delay between tests
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        resultsDiv.innerHTML += `
                <div class="test-query" style="border-left-color: #10b981;">
                    <div class="success">‚úÖ All ${testQueries.length} tests completed!</div>
                    <div class="info">üí° The RAG system is working correctly with ${stats.chunks} chunks</div>
                </div>
            `;

        document.getElementById("runBtn").disabled = false;
      };

      window.clearResults = function () {
        document.getElementById("results").innerHTML = "";
      };
    </script>
  </body>
</html>
